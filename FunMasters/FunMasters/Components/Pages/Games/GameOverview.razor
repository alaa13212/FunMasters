@page "/game/{Id:guid}"
@inject ApplicationDbContext Db
@inject GameCoverStorage GameCoverStorage


<div class="m-5">

    @if (game == null)
    {
        <PageTitle>404 Not Found</PageTitle>
        <h4>Game not found 404</h4>
    }
    else
    {
        <PageTitle>@game.Title</PageTitle>
        <div class="card md:card-side bg-base-200 shadow-md m-auto w-full">
            <figure class="max-md:max-h-[40vh] min-w-[300px] lg:min-w-[450px] md:max-w-1/3 lg:max-w-2/5 xl:max-w-1/2">
                <img src="@GameCoverStorage.GetPublicUrl(game.Id)" alt="@game.Title" class="max-md:w-full"/>
            </figure>
            <div class="card-body">
                <div class="card-title flex flex-col md:flex-row justify-between items-center">
                    <h3 class="text-4xl text-primary">@game.Title</h3>

                    @if (game.AverageRating.HasValue)
                    {
                        <div class="flex md:flex-row-reverse items-center">

                            <RatingStars Rating="@((int)Math.Round(game.AverageRating ?? 0))" class="px-2 rating-lg"/>
                            <span
                                class="max-md:w-0 text-xl md:text-3xl text-primary">@(game.AverageRating?.ToString("0.#") ?? "0")</span>
                        </div>
                    }
                </div>
                <div class="h-max">
                    Suggested By
                    <br/>
                    <strong class="text-lg"><img src="uploads/avatars/@game.SuggestedBy!.Id.ToString("n")" class="md:ms-1 me-1 my-2 w-10 h-10 mask mask-squircle"/> @game.SuggestedBy.UserName</strong>
                </div>
                <div class="divider text-2xl">Reviews</div>
                <div class="grid grid-cols-1 md:grid-cols-fill-[350px] gap-5">
                    @foreach (var rating in game.Ratings)
                    {
                        <div class="flex flex-col">
                            <div class="flex flex-row">
                                <img src="uploads/avatars/@rating.Rater!.Id.ToString("n")" class="me-2 w-30 h-30 mask mask-squircle"/>
                                <div class="flex flex-col gap-2">
                                    <h5 class="text-xl underline">@rating.Rater!.UserName</h5>
                                    <RatingStars Rating="@rating.Score" class="rating-sm"/>
                                    <p>@rating.Score/10 @((RatingValue)rating.Score). @rating.Comment</p>
                                </div>
                            </div>
                            <div class="d-flex flex-column flex-grow-1 justify-content-top">
                                <div
                                    class="d-flex flex-column flex-md-row flex-wrap justify-content-between flex-md-nowrap">

                                </div>

                                <p>
                                    <text></text>
                                    <br/>
                                    
                                </p>
                            </div>
                        </div>

                        @* if (rating != game.Ratings.Last()) *@
                        @* { *@
                        @*     <hr class="d-block d-md-none my-2"/> *@
                        @* } *@
                    }
                </div>
            </div>
        </div>
    }

</div>


@code {
    [Parameter, SupplyParameterFromQuery] public Guid Id { get; set; }

    private Suggestion? game;

    protected override async Task OnInitializedAsync()
    {
        game = await Db.Suggestions.AsNoTracking()
            .Include(s => s.SuggestedBy)
            .Include(s => s.Ratings)
            .ThenInclude(r => r.Rater)
            .FirstOrDefaultAsync(s => s.Id == Id);

        if (game != null)
            game.Ratings = game.Ratings.OrderByDescending(r => string.IsNullOrWhiteSpace(r.Comment) ? -1 : Math.Clamp(r.Comment.Length, 0, 1)).ToList();
    }

}