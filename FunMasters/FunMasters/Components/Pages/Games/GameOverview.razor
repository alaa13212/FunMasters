@page "/game/active"
@page "/game/{Id:guid}"
@using System.Security.Claims
@using FunMasters.Models
@inject ApplicationDbContext Db
@inject NavigationManager NavigationManager
@inject GameCoverStorage GameCoverStorage


<div class="m-5">

    @if (game == null)
    {
        <PageTitle>404 Not Found</PageTitle>
        <h4>Game not found 404</h4>
    }
    else
    {
        <PageTitle>@game.Title</PageTitle>
        <div class="card md:card-side bg-base-200 shadow-md m-auto w-full">
            <figure class="max-md:max-h-[40vh] min-w-[300px] lg:min-w-[450px] md:max-w-1/3 lg:max-w-2/5 xl:max-w-1/2">
                <img src="@GameCoverStorage.GetPublicUrl(game.Id)" alt="@game.Title" class="max-md:w-full"/>
            </figure>
            <div class="card-body">
                <div class="card-title flex flex-col md:flex-row justify-between items-center">
                    <h3 class="text-4xl text-primary">@game.Title</h3>

                    @if (game.AverageRating.HasValue)
                    {
                        <div class="flex md:flex-row-reverse items-center">

                            <RatingStars Rating="@((int)Math.Round(game.AverageRating ?? 0))" class="px-2 rating-lg"/>
                            <span
                                class="max-md:w-0 text-xl md:text-3xl text-primary">@(game.AverageRating?.ToString("0.#") ?? "0")</span>
                        </div>
                    }
                </div>
                <div class="flex flex-row justify-between items-center">
                    <div class="h-max">
                        Suggested By
                        <br/>
                        <strong class="text-lg"><img src="uploads/avatars/@game.SuggestedBy!.Id.ToString("n")" class="md:ms-1 me-1 my-2 w-10 h-10 mask mask-squircle"/> @game.SuggestedBy.UserName</strong>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-end">

                    @if (!string.IsNullOrWhiteSpace(game.SteamLink))
                    {
                        <div>
                            <a href="@game.SteamLink" target="_blank" rel="noopener noreferrer" class="btn btn-primary gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 496 512" fill="currentColor">
                                    <path d="M496 256c0 137-111.2 248-248.4 248-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5 0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3-5.4-13-15.5-23.2-28.5-28.6-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3zm.1-15.6c25.9 0 46.9-21 46.9-46.8 0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z"/>
                                </svg>
                                Steam
                            </a>
                        </div>
                    }
                    
                    </div>

                </div>
                
                @if (game.FinishedAtUtc > DateTime.UtcNow)
                {
                    <div class="flex flex-col items-center content-center">
                        <h3 class="divider text-3xl ">Playing <span class="text-[#F00] font-mono">Dead</span>line</h3>
                        <Countdown EndDate="@game.FinishedAtUtc.Value" class="md:w-max"/>
                    </div>
                }
                
                @if (ratingRecord != null)
                {
                    <div class="divider text-2xl">Finished Playing? - Rate this game</div>
                    <div class="max-w-[650px] w-full mx-auto">
                        <EditForm Model="ratingRecord" method="post" OnValidSubmit="RateGame" FormName="@("rate-" + game.Id.ToString("n"))">
                            <DataAnnotationsValidator/>
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Score</legend>
                                        
                                <InputSelect @bind-Value="ratingRecord.Score" class="select w-full">
                                    <option disabled>Pick a rating</option>
                                    @foreach (RatingValue ratingValue in Enum.GetValues<RatingValue>().OrderDescending())
                                    {
                                        <option value="@ratingValue">(@((int)ratingValue)) @ratingValue</option>
                                    }
                                </InputSelect>
                            </fieldset>
                            <fieldset>
                                <legend class="fieldset-legend">Comment</legend>
                                <InputTextArea @bind-Value="ratingRecord.Comment" id="@("rate-comment-" + game.Id.ToString("n"))" class="textarea h-24 w-full" placeholder="Optional"/>

                            </fieldset>
                            <div class="form-floating mb-3">
                                <label for="@("rate-comment-" + game.Id.ToString("n"))" class="form-label"></label>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-lg btn-primary w-full">Rate</button>
                            </div>
                        </EditForm>
                    </div>
                }
                
                <div class="divider text-2xl">Reviews</div>
                @if (!game.Ratings.Any())
                {
                    <span class="text-center text-xl">No reviews yet</span>
                }
                <div class="grid grid-cols-1 md:grid-cols-fill-[350px] gap-5">
                    @foreach (var ratingModel in _ratings)
                    {
                        var rating = ratingModel.Rating; 
                        <div class="flex flex-col transition-all duration-300">
                            <div class="flex flex-row">
                                <img src="uploads/avatars/@rating.Rater!.Id.ToString("n")" class="me-2 w-30 h-30 mask mask-squircle"/>
                                <div class="flex flex-col gap-2">
                                    <h5 class="text-xl underline">@rating.Rater!.UserName</h5>
                                    <RatingStars Rating="@rating.Score" class="rating-sm"/>
                                    <p>@rating.Score/10 @((RatingValue)rating.Score). 
                                        <span class="spoiler-text @(ratingModel.IsSpoiler ? "spoiler-on" : "")" @onclick="() => ratingModel.IsSpoiler = false">
                                            @rating.Comment
                                        </span>
                                    </p>
                                </div>
                            </div>

                        </div>
                    }
                </div>
            </div>
        </div>
    }

</div>


@code {
    [Parameter, SupplyParameterFromQuery] public Guid Id { get; set; }

    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    
    private Suggestion? game;
    private Guid? myId;

    private RatingRecord? ratingRecord;

    private List<GameRatingViewModel> _ratings;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        if (authState.User.Identity?.IsAuthenticated == true)
            myId = Guid.TryParse(authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out var id) ? id : null;
        
        var query = Db.Suggestions.AsNoTracking()
            .Include(s => s.SuggestedBy)
            .Include(s => s.Ratings)
            .ThenInclude(r => r.Rater);

        if (Id == Guid.Empty)
            game = await query.FirstOrDefaultAsync(s => s.Status == SuggestionStatus.Active);
        else
            game = await query.FirstOrDefaultAsync(s => s.Id == Id);

        if (game != null)
        {
            game.Ratings = game.Ratings.OrderByDescending(r => string.IsNullOrWhiteSpace(r.Comment) ? -1 : Math.Clamp(r.Comment.Length, 0, 1)).ThenBy(r => r.CreatedAtUtc).ToList();
            bool hasNoRatings = myId != null && game.Ratings.All(r => r.RaterId != myId);
            
            _ratings = game.Ratings.Select(r => new GameRatingViewModel(r, hasNoRatings || (myId == null && game.Status == SuggestionStatus.Active))).ToList();
            if (hasNoRatings)
                ratingRecord = new RatingRecord(game);
        }
    }

    
    private async Task RateGame(EditContext context)
    {
        RatingRecord model = (RatingRecord)context.Model;

        Db.Ratings.Add(new Rating
        {
            SuggestionId = model.Game.Id,
            RaterId = myId!.Value,
            Score = (int)model.Score,
            Comment = model.Comment,
        });
        
        await Db.SaveChangesAsync();
        
        NavigationManager.Refresh(true);
    }

    private class GameRatingViewModel(Rating rating, bool isSpoiler)
    {
        public Rating Rating { get; set; } = rating;
        public bool IsSpoiler { get; set; } = isSpoiler;
    }

}