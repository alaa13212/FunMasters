@page "/"
@using FunMasters.Client.Pages.Rating
@inject ISuggestionApiService SuggestionApi
@inject IRatingApiService RatingApi

<PageTitle>Fun Masters</PageTitle>
<div class="m-5">
    @if (_loading)
    {
        <p>Loading...</p>
    }
    else
    {
        @if (HomeData.ActiveSuggestion != null)
        {
            <div class="card md:card-side bg-base-200 shadow-2xl max-w-[1000px] m-auto card-hover">
                <figure>
                    <img class="w-full md:w-max md:h-[35vh]" src="@HomeData.ActiveSuggestion.CoverImageUrl" alt="@HomeData.ActiveSuggestion.Title"/>
                </figure>
                <div class="card-body">
                    <div>
                        <h2 class="card-title text-primary text-3xl md:text-5xl mb-5">@HomeData.ActiveSuggestion.Title</h2>
                        <p class="mb-1">
                            Suggested By<br/><strong><img src="@HomeData.ActiveSuggestion.SuggestedByAvatarUrl" class="ms-3 me-1 my-2 w-6 h-6 mask mask-squircle"/> @HomeData.ActiveSuggestion.SuggestedByUserName</strong>
                        </p>
                        <p>
                            Start: @HomeData.ActiveSuggestion.ActiveAtUtc!.Value.ToLocalTime().ToString("dd/MM/yyyy")<br/>
                        </p>
                    </div>
                    @if (HomeData.ActiveSuggestion.FinishedAtUtc.HasValue)
                    {
                        <div class="flex flex-col items-center content-center">
                            <h3 class="text-3xl my-2">Playing <span class="text-[#F00] font-mono">Dead</span>line</h3>
                            <Countdown EndDate="@HomeData.ActiveSuggestion.FinishedAtUtc.Value" class="md:w-max"/>
                        </div>
                    }
                    <a href="game/active" class="absolute inset-0"></a>
                </div>
            </div>

        }
        else
        {
            <p><em>No active games right now.</em></p>
        }


        @if (NeedsRating is {Count: > 0})
        {
            <div class="max-w-[700px] m-auto">
                <Rater NeedsRating="NeedsRating"/>
            </div>
        }


        @if (HomeData.QueuedSuggestions.Any())
        {
            <div class="divider md:text-2xl md:m-8">Upcoming Queue</div>
            <div class="grid grid-cols-1 md:grid-cols-fill-[400px] gap-3 md:gap-5">
                @{ int i = 1; }
                @foreach (var game in HomeData.QueuedSuggestions)
                {
                    <div class="card card-side bg-base-200 grid grid-cols-2 shadow-2xl overflow-hidden card-hover">
                        <figure>
                            <img src="@game.CoverImageUrl" alt="@game.Title"/>
                        </figure>
                        <div class="card-body">
                            <span class="absolute text-[200px] -bottom-20 -end-5 opacity-10 select-none">@(i++)</span>
                            <h3 class="text-xl mb-0 text-primary">@game.Title</h3>
                            <p>
                                Suggested By<br/><strong><img src="@game.SuggestedByAvatarUrl" class="md:ms-1 me-1 my-2 w-6 h-6 mask mask-squircle"/> @game.SuggestedByUserName</strong>
                            </p>
                            <span>Expected Start:<br/>@game.ActiveAtUtc!.Value.ToLocalTime().ToString("yyyy-MM-dd")</span>
                            <span>Expected End:<br/>@game.FinishedAtUtc!.Value.ToLocalTime().ToString("yyyy-MM-dd")</span>
                        </div>
                        <a href="game/@game.Id" class="absolute inset-0"></a>
                    </div>
                }
            </div>
        }
        else
        {
            <p><em>No games in the queue yet.</em></p>
        }

        @if (HomeData.FinishedSuggestions.Any())
        {
            <div class="divider md:text-2xl md:m-8">Finished Games</div>
            <div class="mb-4 flex justify-end">
                <select class="select select-bordered w-auto" @onchange="OnSortChanged">
                    <option value="@SortingCriteria.FinishDateDescending">Sort by Finish Date (Newest)</option>
                    <option value="@SortingCriteria.FinishDateAscending">Sort by Finish Date (Oldest)</option>
                    <option value="@SortingCriteria.RatingDescending">Sort by Rating (Highest)</option>
                    <option value="@SortingCriteria.RatingAscending">Sort by Rating (Lowest)</option>
                    <option value="@SortingCriteria.Suggester">Sort by Suggester (A-Z)</option>
                </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-fill-[400px] gap-3 md:gap-5">
                @foreach (var game in GetSortedGames())
                {
                    <div class="card card-side bg-base-200 grid grid-cols-2 shadow-xs card-hover">
                        <figure>
                            <img src="@game.CoverImageUrl" alt="@game.Title"/>
                        </figure>
                        <div class="card-body">
                            <h3 class="text-xl mb-0 text-primary">@game.Title</h3>

                            <p>
                                Suggested By
                                <br/>
                                <strong class="flex flex-row items-center gap-2">
                                    <img src="@game.SuggestedByAvatarUrl" class="md:ms-1 me-1 my-2 w-6 h-6 mask mask-squircle"/>
                                    <span class="text-nowrap text-ellipsis overflow-hidden">@game.SuggestedByUserName</span>
                                </strong>

                                @if (game.AverageRating.HasValue)
                                {
                                    <div class="flex flex-col items-center gap-2">
                                        <RatingStars Rating="@game.AverageRating.Value" class="me-2 text-4xl"/>
                                        <span class="text-2xl text-primary">@(game.AverageRating?.ToString("0.#") ?? "0")<small>/10</small></span>
                                    </div>
                                }
                            </p>
                            <span>Finished at:<br/>@game.FinishedAtUtc!.Value.ToLocalTime().ToString("yyyy-MM-dd") - @((int)(game.FinishedAtUtc.Value - game.ActiveAtUtc!.Value).TotalDays) Days</span><br/>
                            <a href="game/@game.Id" class="absolute inset-0"></a>
                        </div>
                    </div>
                }
                @* More Button *@
            </div>

        }
        else
        {
            <p><em>No finished games yet.</em></p>
        }
    }
</div>

@code {
    [PersistentState] public HomePageDto? HomeData { get; set; }
    [PersistentState] public List<NeedRatingModel>? NeedsRating { get; set; }
    
    private bool _loading = true;
    private SortingCriteria _sortBy = SortingCriteria.FinishDateDescending;
    
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            HomeData ??= await SuggestionApi.GetHomeDataAsync();
            
            var authState = await AuthenticationStateTask!;
            if (authState.User.Identity?.IsAuthenticated == true && authState.User.IsInRole("Member"))
                NeedsRating ??= (await RatingApi.GetUnratedSuggestionsAsync()).Select(s => new NeedRatingModel(s)).ToList();
                
        }
        catch (Exception)
        {
            // Handle error silently or show error message
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        _sortBy = Enum.TryParse(e.Value?.ToString(), out SortingCriteria result) ? result : SortingCriteria.FinishDateDescending;
    }

    private IEnumerable<SuggestionDto> GetSortedGames()
    {
        return _sortBy switch
        {
            SortingCriteria.FinishDateDescending => HomeData.FinishedSuggestions.OrderByDescending(g => g.FinishedAtUtc),
            SortingCriteria.FinishDateAscending => HomeData.FinishedSuggestions.OrderBy(g => g.FinishedAtUtc),
            SortingCriteria.RatingDescending => HomeData.FinishedSuggestions.OrderByDescending(g => g.AverageRating ?? 0),
            SortingCriteria.RatingAscending => HomeData.FinishedSuggestions.OrderBy(g => g.AverageRating ?? 0),
            SortingCriteria.Suggester => HomeData.FinishedSuggestions.OrderBy(g => g.SuggestedByUserName ?? ""),
            _ => HomeData.FinishedSuggestions.OrderByDescending(g => g.FinishedAtUtc)
        };
    }

    private enum SortingCriteria
    {
        FinishDateDescending,
        FinishDateAscending,
        RatingDescending,
        RatingAscending,
        Suggester,
    }
}