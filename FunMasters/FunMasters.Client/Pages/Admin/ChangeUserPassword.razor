@page "/Admin/ChangeUserPassword/{UserId:guid}"
@attribute [Authorize(Roles = "Admin")]
@using System.ComponentModel.DataAnnotations
@inject IAdminApiService AdminApi

<PageTitle>Change User Password</PageTitle>
<div class="m-5">
    <h3 class="text-2xl text-center mb-5">Change User Password</h3>

    @if (_successMessage is not null)
    {
        <div class="alert alert-success mb-4">@_successMessage</div>
    }
    else if (_errorMessage is not null)
    {
        <div class="alert alert-error mb-4">@_errorMessage</div>
    }
    else if (_loading)
    {
        <div class="flex justify-center items-center p-8">
            <span class="loading loading-spinner loading-lg"></span>
            <span class="ml-3">Loading user information...</span>
        </div>
    }
    else if (TargetUser is null)
    {
        <div class="alert alert-error">User not found.</div>
    }
    else
    {
        <div class="card bg-base-200 shadow-sm">
            <div class="card-body">
                <p class="mb-4"><strong>User:</strong> @TargetUser.UserName (@TargetUser.Email)</p>

                <EditForm Model="Input" OnValidSubmit="HandleChangePassword" class="flex flex-col gap-4 w-sm">
                    <DataAnnotationsValidator/>
                    <ValidationSummary/>

                    <label class="floating-label">
                        <span>New Password</span>
                        <InputText @bind-Value="Input.NewPassword" type="password" class="input"/>
                    </label>

                    <label class="floating-label">
                        <span>Confirm Password</span>
                        <InputText @bind-Value="Input.ConfirmPassword" type="password" class="input"/>
                    </label>

                    <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span class="loading loading-spinner"></span>
                        }
                        Set New Password
                    </button>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public Guid UserId { get; set; }

    [PersistentState] public UserDto? TargetUser { get; set; }
    [PersistentState] public string? _errorMessage { get; set; }
    private string? _successMessage;
    private bool _loading = true;
    private bool _isSubmitting;

    private ResetPasswordModel Input { get; set; } = new();

    public class ResetPasswordModel
    {
        [Required, DataType(DataType.Password)]
        public string NewPassword { get; set; } = string.Empty;

        [Required, DataType(DataType.Password)]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if(TargetUser != null || _errorMessage != null)
                return;
            
            TargetUser ??= await AdminApi.GetUserAsync(UserId);
            if (TargetUser == null)
                _errorMessage = "User not found.";
        }
        catch (Exception)
        {
            _errorMessage = "Failed to load user.";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleChangePassword()
    {
        if (TargetUser == null)
            return;

        _errorMessage = null;
        _successMessage = null;
        _isSubmitting = true;

        try
        {
            var request = new AdminChangePasswordRequest
            {
                NewPassword = Input.NewPassword
            };

            var result = await AdminApi.ChangeUserPasswordAsync(UserId, request);

            if (result.Success)
            {
                _successMessage = $"Password changed successfully for {TargetUser.UserName}.";
            }
            else
            {
                _errorMessage = result.ErrorMessage ?? "Failed to change password";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}