@inject IRatingApiService RatingApi

@if (NeedsRating is { Count: > 0 })
{
    <div class="divider text-4xl mb-4">Needs Rating</div>
    <p class="text-2xl text-center mb-4">Please rate these games !!</p>
    <div class="grid grid-cols-1 md:grid-cols-fit-[600px] gap-5">
        @foreach (var ratingModel in NeedsRating)
        {
            var game = ratingModel.Suggestion;
            <div class="@("@container")">
                <div class="card @("@xl:card-side") bg-base-300 shadow-xs">
                    <figure class="@("@xl:w-3/7 @max-xl:max-h-[30vh]")">
                        <img src="@game.CoverImageUrl" alt="@game.Title" class="w-full"/>
                    </figure>
                    <div class="card-body">
                        <h3 class="text-xl mb-0 text-primary">@game.Title</h3>
                        Suggested By<br/><strong><img src="@game.SuggestedByAvatarUrl" class="md:ms-1 me-1 my-2 w-6 h-6 mask mask-squircle"/> @game.SuggestedByUserName</strong>
                        <span class="divider">My Rating</span>
                        <EditForm Model="ratingModel" method="post" OnValidSubmit="() => RateGame(ratingModel)" FormName="@("rate-" + game.Id.ToString("n"))">
                            <DataAnnotationsValidator/>
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Score: @ratingModel.Score @ratingModel.GetRatingLabel()</legend>

                                <input type="range" @bind="ratingModel.Score" @bind:event="oninput" class="range w-full" min="0.1" max="10" step="0.1"/>
                            </fieldset>
                            <fieldset>
                                <legend class="fieldset-legend">Comment</legend>
                                <InputTextArea @bind-Value="ratingModel.Comment" id="@("rate-comment-" + game.Id.ToString("n"))" class="textarea h-24 w-full" placeholder="Optional"/>

                            </fieldset>
                            <div class="form-floating mb-3">
                                <label for="@("rate-comment-" + game.Id.ToString("n"))" class="form-label"></label>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-lg btn-primary w-full" disabled="@ratingModel.IsSubmitting">
                                    @if (ratingModel.IsSubmitting)
                                    {
                                        <span class="loading loading-spinner"></span>
                                    }
                                    Rate
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter, EditorRequired] public List<NeedRatingModel>? NeedsRating { get; set; }

    private async Task RateGame(NeedRatingModel model)
    {
        model.IsSubmitting = true;

        try
        {
            var request = new CreateRatingRequest
            {
                SuggestionId = model.Suggestion.Id,
                Score = (int)(model.Score * 10),
                Comment = model.Comment
            };

            var result = await RatingApi.CreateRatingAsync(request);

            if (result.Success)
            {
                NeedsRating!.Remove(model);
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            model.IsSubmitting = false;
        }
    }
}