@page "/my-games"
@attribute [Authorize]
@inject ISuggestionApiService SuggestionApi
@inject NavigationManager Nav

<PageTitle>My Games</PageTitle>

<div class="m-5">

    @if (_loading)
    {
        <p><em>Loadingâ€¦</em></p>
    }
    else
    {
        <h3 class="text-2xl text-center mb-4">My Game Suggestions</h3>

        @if (!UserSuggestions.Any())
        {
            <p><em>No suggestions yet.</em></p>
            <div class="card-actions justify-center">
                <a class="btn btn-primary mb-3" href="/my-games/add">Add Game</a>
            </div>
        }
        else
        {
            <div class="card bg-base-200 shadow-md">
                <div class="card-body">
                    <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
                        <table class="table table-zebra">
                            <thead>
                            <tr>
                                <th>Order</th>
                                <th>Title</th>
                                <th>Is Hidden</th>
                                <th>Added</th>
                                <th>Play Date</th>
                                <th>Finished Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var s in UserSuggestions)
                            {
                                <tr class="hover:bg-base-300">
                                    <td>@s.Order</td>
                                    <td>@s.Title</td>
                                    <td>@s.IsHidden</td>
                                    <td>@s.CreatedAtUtc.ToLocalTime().ToString("yyyy-M-d")</td>
                                    <td>@s.ActiveAtUtc?.ToLocalTime().ToString("yyyy-M-d")</td>
                                    <td>@s.FinishedAtUtc?.ToLocalTime().ToString("yyyy-M-d")</td>
                                    <td>@s.Status</td>
                                    <td>
                                        @if (s.Status == SuggestionStatus.Pending)
                                        {
                                            <a href="/my-games/edit/@s.Id" class="text-primary">Edit</a>
                                            @:|
                                            <a href="/my-games/delete/@s.Id" class="text-primary"> Delete </a>
                                            if (s != UserSuggestions.First(g => g.Status == SuggestionStatus.Pending))
                                            {
                                                @:|
                                                <a class="cursor-pointer text-primary" @onclick="async () => await SortUp(s)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-up inline" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708z"/>
                                                    </svg>
                                                </a>
                                            }
                                            if (s != UserSuggestions.Last())
                                            {
                                                @:|
                                                <a class="cursor-pointer text-primary" @onclick="async () => await SortDown(s)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down inline" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                                                    </svg>
                                                </a>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                    <div class="card-actions justify-end">
                        <a class="btn btn-primary mb-3" href="/my-games/add">Add Game</a>
                    </div>
                </div>
            </div>

        }
    }

</div>

@code {
    [PersistentState] public List<SuggestionDto>? UserSuggestions { get; set; }
    
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadGames();
    }

    private async Task LoadGames()
    {
        _loading = true;

        try
        {
            UserSuggestions ??= await SuggestionApi.GetMySuggestionsAsync();
        }
        catch (Exception)
        {
            // Handle error silently or show error message
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SortUp(SuggestionDto game)
    {
        try
        {
            var request = new ReorderSuggestionRequest
            {
                SuggestionId = game.Id,
                Direction = "up"
            };

            var result = await SuggestionApi.ReorderSuggestionAsync(request);
            if (result.Success)
            {
                await LoadGames();
            }
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private async Task SortDown(SuggestionDto game)
    {
        try
        {
            var request = new ReorderSuggestionRequest
            {
                SuggestionId = game.Id,
                Direction = "down"
            };

            var result = await SuggestionApi.ReorderSuggestionAsync(request);
            if (result.Success)
            {
                await LoadGames();
            }
        }
        catch (Exception)
        {
            // Handle error
        }
    }

}