@page "/game/active"
@page "/game/{Id:guid}"
@using System.Security.Claims
@inject ISuggestionApiService SuggestionApi
@inject IRatingApiService RatingApi
@inject IHltbApiService HltbApi
@inject NavigationManager NavigationManager

<div class="m-5">

    @if (Game == null && !_loading)
    {
        <PageTitle>404 Not Found</PageTitle>
        <h4>Game not found 404</h4>
    }
    else if (Game != null)
    {
        <PageTitle>@Game.Suggestion.Title</PageTitle>
        <div class="flex items-start flex-column lg:flex-row gap-5">
            <div class="card bg-base-200 shadow-md flex-none w-full lg:w-128 @("@container")">
                <figure class="max-h-[50vh]">
                    <img src="@Game.Suggestion.CoverImageUrl" alt="@Game.Suggestion.Title" class="w-full"/>
                </figure>
                <div class="card-body">
                    <div class="card-title flex flex-col md:flex-row justify-between items-center">
                        <h3 class="text-4xl text-primary">@Game.Suggestion.Title</h3>

                        @if (Game.Suggestion.AverageRating.HasValue)
                        {
                            <div class="flex md:flex-row-reverse items-center">
                                <RatingStars Rating="@Game.Suggestion.AverageRating.Value"
                                             class="mx-2 text-5xl md:text-4xl"/>
                                <span
                                    class="max-md:w-0 text-4xl md:text-3xl text-primary">@(Game.Suggestion.AverageRating?.ToString("0.#") ?? "0")<small>/10</small></span>
                            </div>
                        }
                    </div>
                    <div class="flex flex-row justify-between items-center">
                        <div class="h-max">
                            Suggested By
                            <br/>
                            <strong class="text-lg"><img src="@Game.Suggestion.SuggestedByAvatarUrl"
                                                         class="md:ms-1 me-1 my-2 w-10 h-10 mask mask-squircle"/> @Game.Suggestion.SuggestedByUserName
                            </strong>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-end">
                            <div>
                                <a href="@HltbLink()" target="_blank" rel="noopener noreferrer"
                                   class="btn btn-accent gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                         stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    HowLongToBeat
                                </a>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Game.Suggestion.SteamLink))
                            {
                                <div>
                                    <a href="@Game.Suggestion.SteamLink" target="_blank" rel="noopener noreferrer"
                                       class="btn btn-primary gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                             viewBox="0 0 496 512" fill="currentColor">
                                            <path
                                                d="M496 256c0 137-111.2 248-248.4 248-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5 0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3-5.4-13-15.5-23.2-28.5-28.6-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3zm.1-15.6c25.9 0 46.9-21 46.9-46.8 0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z"/>
                                        </svg>
                                        Steam
                                    </a>
                                </div>
                            }
                        </div>

                    </div>
                    @if (Game.Suggestion.ActiveAtUtc <= DateTime.UtcNow)
                    {
                        @if (Game.Suggestion.FinishedAtUtc > DateTime.UtcNow)
                        {
                            <div class="flex flex-col items-center content-center">
                                <h3 class="divider text-3xl ">Playing <span class="text-[#F00] font-mono">Dead</span>line
                                </h3>
                                <Countdown EndDate="@Game.Suggestion.FinishedAtUtc.Value" class="md:w-max"/>
                            </div>
                        }
                    }
                    @if (Game.Suggestion.ActiveAtUtc > DateTime.UtcNow)
                    {
                        <div class="flex flex-col items-center content-center">
                            <h3 class="divider text-3xl ">Starting in:</h3>
                            <Countdown EndDate="@Game.Suggestion.ActiveAtUtc.Value" class="md:w-max"/>
                        </div>
                    }
                    @if (!Game.Suggestion.ActiveAtUtc.HasValue)
                    {
                        <div class="flex flex-col items-center content-center">
                            <h3 class="divider text-3xl ">Game is not queued!</h3>
                        </div>
                    }
                    <HowLongToBeat HltbData="HltbData" HltbLoading="_hltbLoading"/>
                </div>
            </div>
            <div class="flex-1 max-lg:w-full">
                <div class="text-5xl my-6">Reviews</div>
                <div class="card bg-base-200 shadow-md m-auto w-full @("@container")">
                    <div class="card-body">
                        @if (_canRate)
                        {
                            <div class="divider text-2xl">Finished Playing? - Rate this game</div>
                            <div class="max-w-[650px] w-full mx-auto">
                                <EditForm Model="_ratingRecord" method="post" OnValidSubmit="RateGame"
                                          FormName="@("rate-" + Game.Suggestion.Id.ToString("n"))">
                                    <DataAnnotationsValidator/>
                                    <fieldset class="fieldset">
                                        <legend class="fieldset-legend">
                                            Score: @_ratingRecord.Score @_ratingRecord.GetRatingLabel()</legend>

                                        <input type="range" @bind="_ratingRecord.Score" @bind:event="oninput"
                                               class="range w-full" min="0.1" max="10" step="0.1"/>
                                    </fieldset>
                                    <fieldset>
                                        <legend class="fieldset-legend">Comment</legend>
                                        <InputTextArea @bind-Value="_ratingRecord.Comment"
                                                       id="@("rate-comment-" + Game.Suggestion.Id.ToString("n"))"
                                                       class="textarea h-24 w-full" placeholder="Optional"/>

                                    </fieldset>
                                    <div class="form-floating mb-3">
                                        <label for="@("rate-comment-" + Game.Suggestion.Id.ToString("n"))"
                                               class="form-label"></label>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-lg btn-primary w-full"
                                                disabled="@_isSubmittingRating">
                                            @if (_isSubmittingRating)
                                            {
                                                <span class="loading loading-spinner"></span>
                                            }
                                            Rate
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                            <div class="divider"></div>
                        }
                        @if (!Game.Ratings.Any())
                        {
                            <span class="text-center text-xl">No reviews yet</span>
                        }
                        <div class="grid grid-cols-1 md:grid-cols-fill-[450px] gap-5">
                            @foreach (var ratingModel in _ratingViewModels)
                            {
                                var rating = ratingModel.Rating;
                                <div class="flex flex-col transition-all duration-300">
                                    <div class="flex flex-row">
                                        <img src="@rating.RaterAvatarUrl" class="me-2 w-25 h-25 mask mask-squircle"/>
                                        <div class="flex flex-col gap-2">
                                            <h5 class="text-xl underline">@rating.RaterUserName</h5>
                                            <RatingStars Rating="@rating.DecimalScore" class="text-3xl"/>
                                            <p class="whitespace-pre-line">@rating.DecimalScore/10 @rating.RatingLabel.
                                                <span class="spoiler-text @(ratingModel.IsSpoiler ? "spoiler-on" : "")"
                                                      @onclick="() => ratingModel.IsSpoiler = false">
                                                    @rating.Comment
                                                </span>
                                            </p>
                                        </div>
                                    </div>

                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


@code {
    [Parameter, SupplyParameterFromQuery] public Guid Id { get; set; }

    [PersistentState] public SuggestionDetailDto? Game { get; set; }
    [PersistentState] public HltbGameResultDto? HltbData { get; set; }
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private Guid? _myId;
    private bool _loading = true;
    private bool _canRate;
    private bool _isSubmittingRating;

    private RatingRecord _ratingRecord = new();

    private List<GameRatingViewModel> _ratingViewModels = [];
    private bool _hltbLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        try
        {
            var authState = await AuthenticationStateTask!;
            if (authState.User.Identity?.IsAuthenticated == true)
                _myId = Guid.TryParse(authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out var id) ? id : null;

            if (Game == null)
            {
                if (Id == Guid.Empty)
                    Game = await SuggestionApi.GetActiveSuggestionAsync();
                else
                    Game = await SuggestionApi.GetSuggestionDetailsAsync(Id);
                StateHasChanged();
            }

            if (Game != null)
            {
                // Sort ratings: those with comments first, then by creation date
                var sortedRatings = Game.Ratings
                    .OrderByDescending(r => string.IsNullOrWhiteSpace(r.Comment) ? -1 : Math.Clamp(r.Comment.Length, 0, 1))
                    .ThenBy(r => r.CreatedAtUtc)
                    .ToList();

                Game.Ratings = sortedRatings;

                bool hasNoRatings = _myId != null && Game.Ratings.All(r => r.RaterId != _myId);

                _ratingViewModels = Game.Ratings
                    .Select(r => new GameRatingViewModel(r, hasNoRatings || (_myId == null && Game.Suggestion.Status == SuggestionStatus.Active)))
                    .ToList();

                _canRate = hasNoRatings && Game.Suggestion.Status is SuggestionStatus.Active or SuggestionStatus.Finished;
                if (_canRate)
                    _ratingRecord = new RatingRecord();

                try
                {
                    StateHasChanged();
                    HltbData ??= await HltbApi.SearchGameAsync(Game.Suggestion.Title);
                }
                catch (Exception)
                {
                    // Silently fail if HLTB lookup fails
                    HltbData = null;
                }
                finally
                {
                    _hltbLoading = false;
                }
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RateGame(EditContext context)
    {
        if (Game == null || _myId == null)
            return;

        _isSubmittingRating = true;

        try
        {
            var request = new CreateRatingRequest
            {
                SuggestionId = Game.Suggestion.Id,
                Score = (int)(_ratingRecord.Score * 10),
                Comment = _ratingRecord.Comment
            };

            var result = await RatingApi.CreateRatingAsync(request);

            if (result.Success)
            {
                NavigationManager.Refresh(true);
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            _isSubmittingRating = false;
        }
    }

    private string HltbLink()
    {
        return HltbData?.GameUrl ?? $"https://howlongtobeat.com/?q={Game?.Suggestion.Title}";
    }

    private class GameRatingViewModel(RatingDto rating, bool isSpoiler)
    {
        public RatingDto Rating { get; set; } = rating;
        public bool IsSpoiler { get; set; } = isSpoiler;
    }

    private class RatingRecord
    {
        public decimal Score { get; set; } = 10m;
        public string? Comment { get; set; }

        public string GetRatingLabel() => RatingUtils.GetRatingLabel((int)(Score * 10));
    }

}